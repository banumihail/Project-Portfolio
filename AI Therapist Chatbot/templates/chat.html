<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Therapist - Dr. Emma</title>
    <link rel="stylesheet" href="static/css/stylechat.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.6/lottie.min.js"></script>
</head>

<body>
    <div class="chat-container">
        <!-- Left side - Avatar -->
        <div class="avatar-section">
            <div class="avatar-container">
                <div id="avatarContainer" style="width:150px; height:150px; margin:auto;"></div>
            </div>

            <div class="therapist-info">
                <h2 class="therapist-name">Dr. Emma</h2>
                <p class="therapist-title">Licensed AI Therapist</p>

                <div class="status-indicator" id="statusIndicator">
                    <div class="status-dot"></div>
                    <span id="statusText">Ready to listen</span>
                </div>

                <div class="audio-controls">
                    <button class="audio-btn" id="toggleTTS" onclick="toggleTTS()">
                        Voice: ON
                    </button>
                    <button class="audio-btn" id="speedControl" onclick="changeSpeed()">
                        Speed: 1x
                    </button>
                </div>
            </div>
        </div>

        <!-- Right side - Chat -->
        <div class="chat-section">
            <div class="chat-header">
                <div class="header-info">
                    <h1>Your private therapy session</h1>
                    <p>Welcome, {{ username }}! This is a safe space to share your thoughts.</p>
                </div>
                <div class="header-controls">
                    <button class="header-btn" onclick="exportHistory()"> Export</button>
                    <button class="header-btn" onclick="clearHistory()"> Clear</button>
                    <button class="header-btn" onclick="logout()"> Logout</button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <p>Hello {{ username }}! I'm Dr. Emma, your AI therapist. I'm here to listen and support you in a
                        judgment-free environment. Feel free to share whatever is on your mind today.</p>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>

            <!-- Voice recognition wave -->
            <div class="voice-wave" id="voiceWave">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>

            <div class="chat-input-container">
                <textarea class="chat-input" id="messageInput"
                    placeholder="Type your message here or use voice input..." rows="1" maxlength="1000"></textarea>
                <div class="input-controls">
                    <button class="voice-button" id="voiceButton" onclick="toggleVoiceInput()">
                        <i class="fa fa-microphone"></i>
                    </button>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22,2 15,22 11,13 2,9"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ttsEnabled = true;
        let speechRate = 1.0;
        let recognition;
        let isRecording = false;
        let currentUtterance = null;

        // Avatar animation state
        let blinkInterval;
        let speakingTimeout;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            initializePage();
            loadChatHistory();
            startBlinking();
        });

        function initializePage() {
            const messageInput = document.getElementById('messageInput');

            // Auto-resize textarea
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            // Handle Enter key (Shift+Enter for new line)
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Initialize speech recognition if available
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onstart = function () {
                    isRecording = true;
                    updateVoiceButton();
                    document.getElementById('voiceWave').classList.add('active');
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('messageInput').value = transcript;
                };

                recognition.onend = function () {
                    isRecording = false;
                    updateVoiceButton();
                    document.getElementById('voiceWave').classList.remove('active');
                };

                recognition.onerror = function (event) {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                    document.getElementById('voiceWave').classList.remove('active');
                };
            } else {
                // Hide voice button if not supported
                document.getElementById('voiceButton').style.display = 'none';
            }

            messageInput.focus();
        }

        // Avatar animations
        function startBlinking() {
            const leftEye = document.getElementById('leftEye');
            const rightEye = document.getElementById('rightEye');

            blinkInterval = setInterval(() => {
                if (!document.getElementById('avatarFace').classList.contains('speaking')) {
                    leftEye.classList.add('blinking');
                    rightEye.classList.add('blinking');

                    setTimeout(() => {
                        leftEye.classList.remove('blinking');
                        rightEye.classList.remove('blinking');
                    }, 150);
                }
            }, Math.random() * 3000 + 2000); // Random blink every 2-5 seconds
        }

        function startSpeaking() {
            const face = document.getElementById('avatarFace');
            const mouth = document.getElementById('avatarMouth');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            face.classList.add('speaking');
            mouth.classList.add('speaking');
            statusIndicator.classList.add('speaking');
            statusText.textContent = 'Speaking...';
        }

        function stopSpeaking() {
            const face = document.getElementById('avatarFace');
            const mouth = document.getElementById('avatarMouth');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            face.classList.remove('speaking');
            mouth.classList.remove('speaking');
            statusIndicator.classList.remove('speaking');
            statusText.textContent = 'Ready to listen';
        }

        // Text-to-Speech functions
        function speak(text) {
            if (!ttsEnabled || !('speechSynthesis' in window)) return;

            // Cancel any ongoing speech
            window.speechSynthesis.cancel();

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.1;
            currentUtterance.volume = 0.8;

            // Try to use a female voice
            const voices = window.speechSynthesis.getVoices();
            const femaleVoice = voices.find(voice =>
                voice.name.includes('Female') ||
                voice.name.includes('Emma') ||
                voice.name.includes('Samantha') ||
                voice.name.includes('Karen') ||
                voice.gender === 'female'
            );

            if (femaleVoice) {
                currentUtterance.voice = femaleVoice;
            }

            currentUtterance.onstart = startSpeaking;
            currentUtterance.onend = stopSpeaking;
            currentUtterance.onerror = stopSpeaking;

            window.speechSynthesis.speak(currentUtterance);
        }

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            const btn = document.getElementById('toggleTTS');
            btn.textContent = ` Voice: ${ttsEnabled ? 'ON' : 'OFF'}`;

            if (!ttsEnabled) {
                window.speechSynthesis.cancel();
                stopSpeaking();
            }
        }

        function changeSpeed() {
            const speeds = [0.7, 1.0, 1.3, 1.6];
            const currentIndex = speeds.indexOf(speechRate);
            speechRate = speeds[(currentIndex + 1) % speeds.length];

            const btn = document.getElementById('speedControl');
            btn.textContent = ` Speed: ${speechRate}x`;
        }

        // Voice input functions
        function toggleVoiceInput() {
            if (!recognition) {
                alert('Voice recognition is not supported in your browser');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function updateVoiceButton() {
            const btn = document.getElementById('voiceButton');
            if (isRecording) {
                btn.classList.add('recording');
                btn.innerHTML = '<i class="fa fa-stop"></i>'; // Stop icon while recording
            } else {
                btn.classList.remove('recording');
                btn.innerHTML = '<i class="fa fa-microphone"></i>'; // Mic icon when idle
            }
        }

        // Chat functions
        function addMessage(content, isUser, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'therapist-message'}`;

            const time = new Date(timestamp || Date.now()).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            const controls = isUser ? '' : `
                <div class="message-controls">
                    <button class="message-btn" onclick="copyMessage(this)" title="Copy to clipboard">
                        <i class="fa fa-clipboard"></i>
                    </button>
                    <button class="message-btn" onclick="speakMessage(this)" title="Read aloud">
                        <i class="fa fa-volume-high"></i>
                    </button>
                </div>
            `;

            messageDiv.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">${time}</div>
                ${controls}
            `;

            // Store message content for repeat/speak functions
            if (!isUser) {
                messageDiv.setAttribute('data-content', content);
            }

            // Remove welcome message if it exists
            const welcomeMessage = document.getElementById('chatMessages').querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            document.getElementById('chatMessages').appendChild(messageDiv);
            scrollToBottom();

            // Auto-speak therapist messages
            if (!isUser && ttsEnabled) {
                setTimeout(() => speak(content), 500);
            }
        }

        function copyMessage(button) {
            const message = button.closest('.message');
            const content = message.getAttribute('data-content');
            if (content) {
                navigator.clipboard.writeText(content).then(() => {
                    // Visual feedback
                    const originalText = button.innerHTML;
                    button.innerHTML = 'âœ…';
                    button.style.background = '#28a745';

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '#f0f0f0';
                    }, 1000);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    // Fallback for older browsers
                    alert('Message copied: ' + content);
                });
            }
        }

        function speakMessage(button) {
            const message = button.closest('.message');
            const content = message.getAttribute('data-content');
            if (content) {
                speak(content);
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // Disable input while processing
            messageInput.disabled = true;
            document.getElementById('sendButton').disabled = true;
            document.getElementById('voiceButton').disabled = true;

            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Hide typing indicator
                hideTypingIndicator();

                if (response.ok) {
                    // Add therapist response with slight delay for natural feel
                    setTimeout(() => {
                        addMessage(data.response, false, data.timestamp);
                    }, 800);
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    addMessage("I'm sorry, I'm having trouble connecting right now. Please try again.", false);
                }

            } catch (error) {
                hideTypingIndicator();
                addMessage("I'm having some technical difficulties. Please try again in a moment.", false);
                console.error('Error:', error);
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('voiceButton').disabled = false;
                messageInput.focus();
            }
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/api/history');
                if (response.ok) {
                    const data = await response.json();
                    const history = data.history;

                    // Clear welcome message
                    const welcomeMessage = document.getElementById('chatMessages').querySelector('.welcome-message');
                    if (welcomeMessage && history.length > 0) {
                        welcomeMessage.remove();
                    }

                    // Add historical messages
                    history.forEach(msg => {
                        addMessageSilent(msg.content, msg.type === 'user', msg.timestamp);
                    });

                    scrollToBottom();
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function addMessageSilent(content, isUser, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'therapist-message'}`;

            const time = new Date(timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });

            const controls = isUser ? '' : `
            <div class="message-controls">
                <button class="message-btn" onclick="copyMessage(this)" title="Copy to clipboard">
                    <i class="fa fa-clipboard"></i>
                </button>
                <button class="message-btn" onclick="speakMessage(this)" title="Read aloud">
                    <i class="fa fa-volume-high"></i>
                </button>
            </div>
        `;

            messageDiv.innerHTML = `
            <div class="message-bubble">${content}</div>
            <div class="message-time">${time}</div>
            ${controls}
        `;

            if (!isUser) {
                messageDiv.setAttribute('data-content', content);
            }

            document.getElementById('chatMessages').appendChild(messageDiv);
        }


        function exportHistory() {
            const messages = document.querySelectorAll('#chatMessages .message');
            let transcript = `Therapy Session - ${new Date().toLocaleDateString()}\n`;
            transcript += '=' * 50 + '\n\n';

            messages.forEach(msg => {
                const isUser = msg.classList.contains('user-message');
                const content = msg.querySelector('.message-bubble').textContent;
                const time = msg.querySelector('.message-time').textContent;

                const speaker = isUser ? 'You' : 'Dr. Emma';
                transcript += `[${time}] ${speaker}: ${content}\n\n`;
            });

            const blob = new Blob([transcript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `therapy-session-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function clearHistory() {
            if (confirm('Are you sure you want to clear your conversation history? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        // Clear the chat interface
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="welcome-message">
                                <p>Hello! I'm Dr. Emma, your AI therapist. I'm here to listen and support you in a judgment-free environment. Feel free to share whatever is on your mind today.</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error clearing history:', error);
                    alert('Failed to clear history. Please try again.');
                }
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Load voices when available (for better TTS)
        if ('speechSynthesis' in window) {
            function loadVoices() {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    console.log('Available voices loaded:', voices.length);
                }
            }

            loadVoices();
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function () {
            if (currentUtterance) {
                window.speechSynthesis.cancel();
            }
            if (blinkInterval) {
                clearInterval(blinkInterval);
            }
            if (recognition && isRecording) {
                recognition.stop();
            }
        });
        const avatarAnim = lottie.loadAnimation({
            container: document.getElementById('avatarContainer'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'static/animations/Jumping Girl Animation.json'
        });

        let idleInterval;

        avatarAnim.addEventListener('DOMLoaded', () => {
            avatarAnim.setSpeed(0.3); // slow subtle movement
            avatarAnim.play();

        });

        // Start speaking
        function startSpeaking() {
            avatarAnim.setSpeed(1);
        }

        // Stop speaking (go back to idle)
        function stopSpeaking() {
            avatarAnim.setSpeed(0.3);
        }
    </script>
</body>

</html>